# Compiler Project1 Report

11811712 江川

### 1.词法分析

词法分析挺好做的，把 Appendix A 里的 Token 复制粘贴下来，写对应的符号就好了。

需要写的就 `INT`,`FLOAT`,`CHAR`,`ID` 四个正则。

### 2.语法分析

这个更简单，Appendix B 直接复制下来，用正则把 `->` 改成 `:`， `$` 改成 `%empty`， 再加上封号，语法就没问题了！能编译过了！

不过这时候还有大量 `shift/reduce conflict`，把运算符优先级加上，给 `IF` 专门定下优先级，搞定了。

然后是构建语法树，`YYSTYPE` 不好用啊，加了 `%union` 也麻烦， 不如自己定义一个覆盖掉，`ASTNode.h` 出现了。然后是大量的复制粘贴将所有的 `yyvalue`, `$$` 替换成自定义的语法树类型。再给树定义一个中序遍历输出，除了没有行号都跟样例一样了。

那就加行号，行号太简单了，Flex里加个 `YY_USER_ACTION` 宏搞定了，查了文档 Bison 会自动 Merge 子节点位置信息到父节点，一行代码都不用写。

还差个报错信息。emmmm 报错信息真难搞，我咋知道为啥有时候 Bison 没法正确理解我想加的错误。行吧试了一万次总算能跟样例匹配上了。说实话我觉得 Bison 原本自带的那个报错信息挺好的，`%define parse.error detailed` 开了多香，可惜开不得。

### 3.Bonus

开始放飞自我，然后被限制的工具链和语法树拽了下来。

##### Comment

Comment 好做啊，只用写词法分析不返回注释就好了。一个单行注释正则，一个多行注释正则，搞定。

诶诶诶多行注释你咋回事的怎么是贪婪匹配，直接从第一个 `/*` 到最后一个 `*/` 全吞了。让我来查查 Flex 怎么搞非贪婪。嗯居然不支持非贪婪闭包 `*?`，那就得在 `/*`,`*/` 之间排除掉结束字符。啊这个正则真麻烦，不干了直接匹配 `/*` 然后 `while (true)` 吞掉中间字符，记得更新 `yylloc` 就行。

##### Unicode Identify

支持 Unicode 标识符，比如说中文变量名什么的。还好我悄悄学习了会儿知道了一个 `UAX #31` 的 Unicode 标准，就是规范 Identify 格式的。

好，开抄。这表这么大肯定不是让我手写的，抄就完事了。嗯？Flex的正则匹配是单字节的？也就是说 `[正-则]` 这个区间实际上会被理解为 `[\xe6\xad(\xa3-\xe5)\x88\x99]`，而不是 `[(\xe6\xad\xa3)-(\xe5\x88\x99)]`。那咋办啊，换工具斯南肯定不让。那我就写个脚本枚举下？变成 `\xe6\xad\xa3|\xe5\x88\x99`。`./identifier/src/Identifier_UAX31_compress.kt` 搞定，不过这个正则也太长了吧。放进 Flex 它居然跟我说 `Definition value for {ID_START} too long`，我居然还需要把正则拆成好多段再用 `|` 连起来绕开这个限制，脚本走起。

##### String

String多好用，做了做了，但我仅仅满足于简单的String吗？不！String Template 走起。 `"a + 10 = ${ a + 10 }"` 这种模板插值多香！

模板插值在 `${}` 里可以放一个 `Exp`，那就需要语法分析解析 `Exp` 了，词法分析就得把字符串截成 `"a + 10 = ${`， `ID: a`，`PLUS`，`INT: 10`, `}"`，完美。顺带加个深度，把嵌套的模板也解决吧（见样例ex3）。

##### for, break, continue

考虑加个 for 循环，但是我真的需要标准 for 循环吗？ `for (int i = 0; i < len; i++)`，这种格式也太麻烦了点吧。不如来点现代化的 for in range。`for i in 1..10` 看上去多清楚。

然后接下来考虑 `break` 和 `continue`，这两个语法简直就跟 `return` 一样简单。不过我似乎需要支持一下 `label` 简化多层循环的转跳？`out@for i in 1..10 { break@out; }` 看上去挺不错，啊不对 `@` 字符在测试样例中用过了，要报 `unknown lexeme @` 的。行吧那标签的语法还是传统点的 `:` 分隔符吧。

##### import module

多文件编译，这个 feature 我觉得有必要。不过不要搞成 c 那样直接把另一份文件粘贴到头部，那太暴力了。最好能支持循环 import。那语法就定义成 `import "a.spl";` 或者 `import "a.spl" as m; `。怎么导入变量表肯定是下一个 project 的内容了，这次语法支持就行了。

